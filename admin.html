<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Actualizaci√≥n JSON</title>
    <style>
        :root {
            --primary: #007BFF;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --secondary: #6c757d;
            --bg: #f8f9fa;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        header {
            text-align: center;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        header h1 {
            color: var(--primary);
            margin: 0 0 0.5rem;
            font-size: 2rem;
        }

        .config-card {
            background: #fff3cd;
            border: 2px solid var(--warning);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .config-card h3 {
            margin-top: 0;
            color: #856404;
        }

        .config-item {
            margin: 0.8rem 0;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 50px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-secondary { background: var(--secondary); color: white; }

        .feedback {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid;
            display: none;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .feedback.success {
            background: #d4edda;
            border-color: var(--success);
            color: #155724;
        }

        .feedback.error {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }

        .feedback.loading {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .debug-section h3 {
            margin-top: 0;
            color: var(--secondary);
        }

        .debug-item {
            background: white;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            border-left: 3px solid var(--primary);
        }

        .log-entry {
            padding: 0.5rem;
            margin: 0.3rem 0;
            background: white;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .log-success { border-left: 3px solid var(--success); }
        .log-error { border-left: 3px solid var(--danger); }
        .log-info { border-left: 3px solid var(--primary); }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .btn-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß Panel de Administraci√≥n</h1>
            <p>Actualizaci√≥n de datos JSON para consulta de Spools</p>
        </header>

        <div class="config-card">
            <h3>‚öôÔ∏è Configuraci√≥n Actual</h3>
            <div class="config-item">
                <strong>URL Script:</strong> <span id="current-url">Cargando...</span>
            </div>
            <div class="config-item">
                <strong>Estado:</strong> 
                <span id="status-badge" class="status-badge status-offline">
                    üî¥ Verificando...
                </span>
            </div>
        </div>

        <div class="control-group">
            <label for="script-url">üîó URL del Google Apps Script:</label>
            <input type="url" id="script-url" placeholder="https://script.google.com/macros/s/...">
            <small style="color: #666; margin-top: 0.5rem; display: block;">
                Si el script no responde, pega aqu√≠ la nueva URL desplegada
            </small>
        </div>

        <div class="control-group">
            <label for="password">üîê Contrase√±a de Administrador:</label>
            <input type="password" id="password" placeholder="Ingresa contrase√±a">
        </div>

        <div class="btn-group">
            <button id="test-btn" class="btn-secondary">üîç Probar Conexi√≥n</button>
            <button id="update-btn" class="btn-primary">üîÑ Actualizar JSON</button>
            <button id="diagnose-btn" class="btn-warning">üêõ Diagn√≥stico</button>
        </div>

        <div id="feedback" class="feedback"></div>

        <div class="debug-section">
            <h3>üìä Logs y Diagn√≥stico</h3>
            <div id="logs-container">
                <p style="color: #666;">Los logs aparecer√°n aqu√≠...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n inicial
        let SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznfAPDO0vy45qmDeD7od-3SOqnspC_dquWSwG_CfxXC-j0lZzSG-dxhB_5qZK2O_j5QQ/exec';
        const PASSWORD = 'Narkis2025';

        const elements = {
            scriptUrl: document.getElementById('script-url'),
            password: document.getElementById('password'),
            testBtn: document.getElementById('test-btn'),
            updateBtn: document.getElementById('update-btn'),
            diagnoseBtn: document.getElementById('diagnose-btn'),
            feedback: document.getElementById('feedback'),
            currentUrl: document.getElementById('current-url'),
            statusBadge: document.getElementById('status-badge'),
            logsContainer: document.getElementById('logs-container')
        };

        // Inicializaci√≥n
        elements.scriptUrl.value = SCRIPT_URL;
        elements.currentUrl.textContent = SCRIPT_URL;

        // Funciones auxiliares
        function showFeedback(message, type = 'info') {
            elements.feedback.textContent = message;
            elements.feedback.className = `feedback ${type}`;
            elements.feedback.style.display = 'block';
            
            if (type !== 'loading') {
                setTimeout(() => elements.feedback.style.display = 'none', 5000);
            }
        }

        function addLog(message, type = 'info') {
            const log = document.createElement('div');
            log.className = `log-entry log-${type}`;
            log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            elements.logsContainer.insertBefore(log, elements.logsContainer.firstChild);
            
            // Mantener solo √∫ltimos 20 logs
            while (elements.logsContainer.children.length > 20) {
                elements.logsContainer.removeChild(elements.logsContainer.lastChild);
            }
        }

        function updateStatus(isOnline, message) {
            elements.statusBadge.className = `status-badge ${isOnline ? 'status-online' : 'status-offline'}`;
            elements.statusBadge.textContent = `${isOnline ? 'üü¢' : 'üî¥'} ${message}`;
        }

        async function checkConnection() {
            try {
                addLog('Verificando conexi√≥n con el script...', 'info');
                const response = await fetch(`${SCRIPT_URL}?action=ping&t=${Date.now()}`, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (response.ok) {
                    const data = await response.json();
                    updateStatus(true, 'Online');
                    addLog(`‚úÖ Script conectado: ${data.message}`, 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus(false, 'Offline');
                addLog(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                return false;
            }
        }

        async function testConnection() {
            if (elements.password.value !== PASSWORD) {
                showFeedback('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }

            showFeedback('üîç Probando conexi√≥n...', 'loading');
            elements.testBtn.disabled = true;

            try {
                const pingStart = Date.now();
                const pingResponse = await fetch(`${SCRIPT_URL}?action=ping&t=${Date.now()}`);
                const pingTime = Date.now() - pingStart;

                if (!pingResponse.ok) throw new Error(`HTTP ${pingResponse.status}`);
                
                const pingData = await pingResponse.json();
                addLog(`‚úÖ Ping exitoso (${pingTime}ms)`, 'success');

                const dataResponse = await fetch(`${SCRIPT_URL}?action=getData&t=${Date.now()}`);
                if (!dataResponse.ok) throw new Error(`HTTP ${dataResponse.status}`);
                
                const dataResult = await dataResponse.json();
                addLog(`üìä Datos disponibles: ${dataResult.recordCount} registros`, 'success');

                showFeedback(`‚úÖ Conexi√≥n exitosa - ${dataResult.recordCount} registros disponibles`, 'success');
                updateStatus(true, 'Online y funcionando');

            } catch (error) {
                showFeedback(`‚ùå Error: ${error.message}`, 'error');
                addLog(`‚ùå Prueba fallida: ${error.message}`, 'error');
            } finally {
                elements.testBtn.disabled = false;
            }
        }

        async function updateJson() {
            if (elements.password.value !== PASSWORD) {
                showFeedback('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }

            showFeedback('üîÑ Actualizando JSON...', 'loading');
            elements.updateBtn.disabled = true;
            addLog('Iniciando actualizaci√≥n del JSON...', 'info');

            try {
                const startTime = Date.now();

                // Usar GET con par√°metros en lugar de POST para evitar problemas de CORS
                const url = `${SCRIPT_URL}?action=update&password=${encodeURIComponent(PASSWORD)}&timestamp=${encodeURIComponent(new Date().toISOString())}&_=${Date.now()}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });

                // Debido a no-cors, intentamos con POST tradicional si GET falla
                const responsePost = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify({
                        action: 'update',
                        password: PASSWORD,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!responsePost.ok) {
                    throw new Error(`HTTP ${responsePost.status}: ${responsePost.statusText}`);
                }

                const result = await responsePost.json();
                const duration = Date.now() - startTime;

                if (result.status === 'success') {
                    showFeedback(`‚úÖ Actualizaci√≥n exitosa (${duration}ms)`, 'success');
                    addLog(`‚úÖ JSON actualizado: ${result.recordCount} registros`, 'success');
                    addLog(`üìÅ Archivo: ${result.fileName}`, 'info');
                    addLog(`üîó URL: ${result.fileUrl}`, 'info');
                    
                    // Mostrar URL para copiar
                    if (result.fileUrl) {
                        addLog('üí° Copia esta URL para script.js:', 'info');
                        addLog(result.fileUrl, 'success');
                    }
                } else {
                    throw new Error(result.message || 'Error desconocido');
                }

            } catch (error) {
                showFeedback(`‚ùå Error: ${error.message}`, 'error');
                addLog(`‚ùå Actualizaci√≥n fallida: ${error.message}`, 'error');
                addLog('üí° Intenta actualizar desde Google Sheets directamente', 'info');
            } finally {
                elements.updateBtn.disabled = false;
            }
        }

        async function runDiagnostics() {
            showFeedback('üêõ Ejecutando diagn√≥stico...', 'loading');
            elements.diagnoseBtn.disabled = true;

            addLog('=== INICIO DIAGN√ìSTICO COMPLETO ===', 'info');
            addLog(`Navegador: ${navigator.userAgent}`, 'info');
            addLog(`URL configurada: ${SCRIPT_URL}`, 'info');

            try {
                // Test 1: Conectividad general
                try {
                    await fetch('https://www.google.com', { mode: 'no-cors' });
                    addLog('‚úÖ Conectividad a Internet: OK', 'success');
                } catch {
                    addLog('‚ùå Sin conexi√≥n a Internet', 'error');
                }

                // Test 2: Ping al script
                try {
                    const ping = await fetch(`${SCRIPT_URL}?action=ping&t=${Date.now()}`);
                    if (ping.ok) {
                        const data = await ping.json();
                        addLog(`‚úÖ Script Ping: OK (v${data.version || '?'})`, 'success');
                    } else {
                        addLog(`‚ùå Script Ping: HTTP ${ping.status}`, 'error');
                    }
                } catch (e) {
                    addLog(`‚ùå Script Ping: ${e.message}`, 'error');
                }

                // Test 3: Obtener datos
                try {
                    const getData = await fetch(`${SCRIPT_URL}?action=getData&t=${Date.now()}`);
                    if (getData.ok) {
                        const data = await getData.json();
                        addLog(`‚úÖ GetData: ${data.recordCount} registros`, 'success');
                        addLog(`üìã Headers: ${data.headers?.join(', ')}`, 'info');
                    } else {
                        addLog(`‚ùå GetData: HTTP ${getData.status}`, 'error');
                    }
                } catch (e) {
                    addLog(`‚ùå GetData: ${e.message}`, 'error');
                }

                addLog('=== FIN DIAGN√ìSTICO ===', 'info');
                showFeedback('‚úÖ Diagn√≥stico completado - Ver logs', 'success');

            } catch (error) {
                addLog(`‚ùå Error en diagn√≥stico: ${error.message}`, 'error');
                showFeedback(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                elements.diagnoseBtn.disabled = false;
            }
        }

        // Event Listeners
        elements.testBtn.addEventListener('click', testConnection);
        elements.updateBtn.addEventListener('click', updateJson);
        elements.diagnoseBtn.addEventListener('click', runDiagnostics);

        elements.scriptUrl.addEventListener('change', (e) => {
            const newUrl = e.target.value.trim();
            if (newUrl && newUrl.includes('script.google.com')) {
                SCRIPT_URL = newUrl;
                elements.currentUrl.textContent = newUrl;
                addLog(`URL actualizada: ${newUrl}`, 'info');
                checkConnection();
            }
        });

        // Verificaci√≥n inicial
        setTimeout(checkConnection, 1000);
    </script>
</body>
</html>